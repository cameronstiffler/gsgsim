
# Copilot Instructions — GSG Simulator (STRICT)

## Mission
Make **small, surgical** changes to `gsg_sim.py` and related files to implement the provided task card. **Do not** degrade working behavior, **do not** move imports, **do not** duplicate functions, and **always** show a unified diff of your edits.

---

## Non-Negotiable Guardrails

1) **Import Sentry — do not move or insert above it**
   The file begins with this exact header in this order. Never place *anything* above it (no comments, no blank lines, no code).  
   If a new import is needed, add it **inside** the correct section below.

   ```python
   # ===== IMPORTS SENTRY: DO NOT MOVE OR INSERT ANYTHING ABOVE THIS LINE =====
   from __future__ import annotations

   # Standard library imports
   import argparse
   import json
   import os
   import random
   import re
   import sys
   from collections import deque
   from dataclasses import dataclass, field
   from enum import Enum, auto
   from typing import Any, Deque, Dict, List, Optional, TextIO, Tuple, Callable

   # Third-party imports
   from rich.console import Console
   from rich.table import Table

   # ===== END IMPORTS SENTRY =====

	2.	One definition only (no F811)
Before adding/changing any function/class, search for an existing definition and modify it in place. Do not create duplicates. Especially:
_select_ui, TerminalUI.run_loop, RichUI.run_loop, draw, deploy_from_hand, deploy_with_cost, use_ability_cli, end_of_turn, distribute_wind, apply_wind_with_resist, parse_rank, _print_board, Status.
	3.	Do not change public APIs (signatures/semantics)
	•	distribute_wind(owner, total, *, auto=False, allow_cancel=False) -> Optional[bool]
	•	apply_wind_with_resist(attacker_owner, defender_owner, target, amount) -> int
	•	deploy_with_cost(gs, player, hand_idx, pick_wind, pick_burn) -> bool (if present)
	•	UI methods: TerminalUI.render/run_loop, RichUI.render/run_loop
	•	Models: Player.board/hand/deck/retired, Card.rank/abilities/wind, GameState.p1/p2/turn_player/phase/turn_number/rng/shared_dead
	4.	Separation of concerns
	•	distribute_wind handles wind only. Do not mix gear/meat/power here.
	•	Gear/meat burning occurs in a dedicated cost-payment function using the shared dead pool.
	•	UI code calls engine functions; don’t move engine logic into UI.
	5.	Naming consistency
	•	Use board for in-play goons (never field).
	•	Don’t shadow dataclasses.field.
	6.	Style constraints
	•	Max line length: 100.
	•	Prefer implicit concatenation for long strings:

HELP = (
    "commands: help | quit(q) | end(e) | "
    "deploy(d) <hand_idx> | use(u) <src_idx> <abil_idx> [tgt_idx]"
)


	•	No list comprehensions for side effects (use for loops).
	•	Keep Console() creation inside RichUI only.

⸻

Change Process (what you must output)

Always respond with a unified diff (--- a/... / +++ b/...) for each file you modify, touching only the relevant lines. Do not propose broad refactors. Keep edits minimal and directly tied to the task card.

Example:

--- a/gsg_sim.py
+++ b/gsg_sim.py
@@
- self.console.print(f"Type 'help' for commands. 'quit' to exit.")
+ self.console.print("Type 'help' for commands. 'quit' to exit.")


⸻

Pre-Edit Checklist

Before you modify code, verify:
	•	I am not moving or inserting anything above the Import Sentry.
	•	The symbol I’m changing does not already exist elsewhere (avoid duplicates).
	•	I am not changing any public API signature listed above.
	•	I am not mixing gear/meat logic into distribute_wind.
	•	I will keep edits under 100 characters per line and avoid side-effect list comprehensions.

⸻

Post-Edit Verification (run these commands)

After applying your patch, ensure you include these commands for the user to run:

isort gsg_sim.py
autoflake --in-place --remove-all-unused-imports --remove-unused-variables gsg_sim.py
black gsg_sim.py --line-length 100
flake8 gsg_sim.py --max-line-length=100
python -m py_compile gsg_sim.py
python gsg_sim.py --ui rich

Pass criteria:
	•	flake8 → 0 errors
	•	py_compile passes
	•	Simulator boots; commands help, deploy, use, end, quit work
	•	Import Sentry unchanged and still at top
	•	No duplicate function definitions
	•	Deploy cost enforcement works (wind split across friendly goons, no overpay; gear/meat burn from shared dead pool)

⸻

Known Hotspots & Canonical Fixes
	•	Enum rank printing → use rank.name or _rank_str(rank) to render SL/SG/BG, not Rank.SL.
	•	Self-pay wind during deploy → call:

apply_wind_with_resist(player, player, payer_card, amount)

(Do not call with gs or treat as enemy attack.)

	•	distribute_wind → wind-only; operates on owner.board; call destroy_if_needed after increments.
	•	Graceful quit → wrap input loops in try/except KeyboardInterrupt and catch EOFError around input/console.input.

⸻

If Unsure

If a requested change could break these guardrails, stop and produce a minimal alternative patch, or ask for clarification. Never “helpfully” relocate imports, duplicate functions, or alter public signatures.
