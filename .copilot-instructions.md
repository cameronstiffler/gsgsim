

Mission

Make small, surgical edits to gsg_sim.py to fix lints/bugs without breaking working code or moving stable structures. If uncertain, leave code unchanged.

⸻

Hard Guardrails (do not violate)
	1.	Do not move these lines or place anything above them:

from __future__ import annotations
import argparse
import json
import os
import random
import re
import sys
from collections import deque
from dataclasses import dataclass, field
from enum import Enum, auto
from typing import Any, Deque, Dict, List, Optional, TextIO, Tuple
from rich.console import Console
from rich.table import Table

	•	These must remain at the very top in this order (E402/F404 protection).
	•	If you need new imports, append them below this block, grouped properly (stdlib → third-party → local), but never insert anything above from __future__ import annotations.

	2.	Never create duplicate definitions (F811). Before adding/modifying a function/class, search first:
	•	_select_ui, TerminalUI.run_loop, RichUI.run_loop
	•	draw, deploy_from_hand, use_ability_cli, end_of_turn
	•	distribute_wind, apply_wind_with_resist, parse_rank, _print_board, Status
If a definition exists, update it in place; do not create a second definition.
	3.	Do not reintroduce mid-file imports (E402). All imports stay in the top block.
	4.	Do not rename or change signatures of these APIs:
	•	distribute_wind(owner, total, *, auto=False, allow_cancel=False) -> Optional[bool]
	•	apply_wind_with_resist(attacker_owner, defender_owner, target, amount) -> int
	•	deploy_with_cost(gs, player, hand_idx, pick_wind, pick_burn) -> bool
	•	TerminalUI.render(gs), TerminalUI.run_loop(gs)
	•	RichUI.render(gs), RichUI.run_loop(gs)
	•	Models: Player.board/hand/deck/retired, Card.rank/abilities/wind, GameState.p1/p2/turn_player/phase/turn_number/rng
	5.	Keep concerns separate:
	•	distribute_wind handles wind only; do not burn gear/meat/power here.
	•	Gear/meat burning stays in the dedicated cost-payment function (shared dead pool rules).
	6.	Naming consistency: use board everywhere (not field) for in-play goons. Do not shadow field from dataclasses.
	7.	Style & lint constraints:
	•	Max line length 100.
	•	No list comprehensions for side effects.
	•	Use double quotes inside getattr(..., "x", ...) for E231-friendly spacing.
	•	Keep Console() creation inside the Rich UI class only.

⸻

Behavioral Rules (don’t change)
	•	Deploy wind payment can be split across multiple friendly goons; no overpay.
	•	Self-payment uses apply_wind_with_resist(player, player, src, amount) so resist does not reduce payment.
	•	Destroy goons when wind crosses the threshold (call destroy_if_needed after wind changes).
	•	Start-of-turn draw behavior remains as implemented.

⸻

Allowed Edits (safe operations)
	•	Wrap too-long lines (E501) using implicit parentheses.
	•	Convert f-strings with no {} to plain strings (F541).
	•	Remove unused locals/imports (F841/F401) only if truly unused after the change.
	•	Move misplaced imports up into the top block (never down).

⸻

Pre-Edit Checklist (Copilot must reason about this)
	•	Is there an existing definition of the symbol I’m about to create? If yes, edit that one.
	•	Will my change move, duplicate, or rename anything in the import header? If yes, don’t.
	•	Am I mixing gear/meat logic into distribute_wind? If yes, don’t.
	•	Am I changing a public signature listed above? If yes, don’t.

⸻

Patch Style (what to output)
	•	Provide a unified diff against gsg_sim.py only.
	•	Touch only the lines needed to fix the specific issues.
	•	Do not suggest unrelated refactors.
	•	Example format:

--- a/gsg_sim.py
+++ b/gsg_sim.py
@@
 from typing import Any, Deque, Dict, List, Optional, TextIO, Tuple
 from rich.console import Console
 from rich.table import Table
+from typing import Callable  # if needed, keep here (top block), not mid-file
@@
-self.console.print(f"Type 'help' for commands. 'quit' to exit.")
+self.console.print("Type 'help' for commands. 'quit' to exit.")



⸻

Known Hotspots (fix exactly like this)
	•	Deploy wind call site (self-pay):

# WRONG
apply_wind_with_resist(gs, src, a)
# RIGHT
apply_wind_with_resist(player, player, src, a)


	•	distribute_wind must be wind-only and operate on owner.board. Use the safe allocator and then destroy_if_needed for any card that crossed the limit.
	•	Mid-file imports (e.g., from typing import Callable) must be moved to the top import block only.
	•	Duplicate UI methods: keep one run_loop per class; remove duplicates.

⸻

Post-Edit Verification (Copilot: list these commands for the user)

isort gsg_sim.py
autoflake --in-place --remove-all-unused-imports --remove-unused-variables gsg_sim.py
black gsg_sim.py --line-length 100
flake8 gsg_sim.py --max-line-length=100
python -m py_compile gsg_sim.py

Pass criteria: zero flake8 errors; compiles; interactive UI still runs; deploy/use/end commands behave as before.

⸻

If in doubt

Stop and propose a minimal patch that keeps imports and function boundaries intact. Do not invent new helpers, move top imports, or duplicate existing functions.

- Always break long strings (like HELP messages or error text) into multiple lines using parentheses and implicit string concatenation.  
  Example:
  ```python
  HELP = (
      "commands: help | quit(q) | end(e) | deploy(d) <hand_idx> | "
      "use(u) <src_idx> <abil_idx> [tgt_idx]"
  )


- Do not use backslashes \ for line continuation.


