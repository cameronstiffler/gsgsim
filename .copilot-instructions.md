# Copilot Instructions for Goon Squad Galaxy Simulator

## Architecture Overview

- **Modular Design:** Core logic is split into `gsgsim/` modules:
  - `models.py`: Game dataclasses (`Player`, `Card`, `Ability`, `Status`, `GameState`, `Rank`).
  - `loader.py`: Deck loading/parsing (`load_deck_json`, `build_cards`, `find_squad_leader`, `parse_rank`).
  - `engine.py`: Turn flow, deploy/use commands, UI selection (`deploy_from_hand`, `start_of_turn`, `end_of_turn`, `select_ui`).
  - `payments.py`: Wind payment logic (`distribute_wind`, `_apply_wind_safely`).
  - `rules.py`: **Single source of truth for rules/helpers** (`apply_wind_with_resist`, `destroy_if_needed`, `can_target_card`).
  - `ui/terminal.py`, `ui/rich_ui.py`: CLI and rich UI rendering/command loops.
  - `main.py`: CLI/bootstrap, game setup, argument parsing.

- **Entrypoints:**
  - `gsg_sim.py`: Facade for CLI and import surface.
  - Run with `python gsg_sim.py [--ui rich] [--ai p1|p2|both]`.

## Guardrails (Must Follow)

- **Single source of truth for rules:**  
  - Edit ONLY `gsgsim/rules.py` for rule helpers.  
  - Do NOT re-define helpers in `engine` or `ui`.  

- **Wind mutations:**  
  - All wind changes must call `rules.apply_wind*`.  
  - Never mutate `card.wind` directly outside initialization.  

- **Deploy path:**  
  - UI must call `engine.deploy_from_hand(gs, gs.turn_player, idx[, chooser])`.  
  - Do NOT create alternate deploy helpers in UI.  

- **Module boundaries:**  
  - `rules.py` has no imports from app modules.  
  - `payments.py` can import from `rules.py`, never from `engine`.  
  - `ui/` imports engine functions lazily inside methods to avoid circular imports.  

- **No duplicate definitions:**  
  - Each function/class lives in one place only.  
  - If a helper is missing, add it to the canonical module, not in multiple places.  

- **Deprecated symbols:**  
  - `deploy_cli` and other deprecated helpers are banned.  
  - Pre-commit checks enforce this.  

- **Imports:**  
  - Top-level only (except lazy UI imports noted above).  
  - Always start files with `from __future__ import annotations`.  

## Developer Workflow

- **Environment Setup:**  
  - Use `.venv` and `requirements.txt`.  
  - Activate with `source .venv/bin/activate`.  

- **Testing & CI:**  
  - Run tests:  
    ```bash
    pytest -q
    ```  
  - Pre-commit:  
    ```bash
    pre-commit run -a
    ```  
  - CI runs in GitHub Actions via `.github/workflows/ci.yml`.  

- **Game Launch:**  
  - CLI:  
    ```bash
    python gsg_sim.py --ui cli
    ```  
  - Rich UI:  
    ```bash
    python gsg_sim.py --ui rich
    ```  
  - AI:  
    ```bash
    python gsg_sim.py --ai p2
    ```  

## Project-Specific Patterns

- **Wind Payment:** Use `distribute_wind(player, cost, auto=True)`. Manual pay via `manual_pay_cli`.  
- **Retire/KO:** Goons with `wind >= 4` are retired via `rules.destroy_if_needed`.  
- **Decks:** `narc_deck.json` and `pcu_deck.json` loaded through `loader.py`.  
- **Turn Flow:** Always call `start_of_turn(gs)` and `end_of_turn(gs)` for transitions.  

## Examples

- **Deploy a card**
  ```python
  deploy_from_hand(gs, gs.turn_player, idx)
  ```

- **Pay wind**
  ```python
  distribute_wind(player, 2, auto=True)
  ```

- **Run game**
  ```bash
  python gsg_sim.py --ui rich --ai both
  ```

---

## Required Process When Adding Code

1. Generate minimal diffs.  
2. Only touch the listed files.  
3. After edits, run:  
   ```bash
   pre-commit run -a && pytest -q
   ```  
4. If failures occur, show failing diff + exact command. Stop there.  

---

This file acts as the authoritative contract for both GPT-5 and GitHub Copilot.
